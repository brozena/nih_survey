---
title: "NIH BD/Finhealth Survey - Models"
output:
  rmarkdown::github_document:
    html_preview: false
---

```{r class.source = 'fold-hide', warning=FALSE, message=FALSE}
library(tidyverse)
library(lme4)
library(ordinal)
library(performance)
library(marginaleffects)
library(kableExtra)
library(flextable)
```

## Load data

```{r}
load('data/NIH_survey.Rdata')
```

## Descriptive statistics

### Summary statistics of all variables

```{r, warning=FALSE, message=FALSE}
summary(wide)
```

### Means of outcome for each vignette

```{r, warning=FALSE, message=FALSE}
tab <- long %>% group_by(actors, context, moodstate) %>%
summarize(
          Mean = mean(y, na.rm = TRUE),
          Median = median(y, na.rm = TRUE),
          SD = sd(y, na.rm = TRUE),
          ci = list(mean_cl_normal(y, conf.int = .95)),
          obs = n_distinct(participant)
) %>% unnest(c(ci))
flextable(tab) %>% colformat_double(digits = 2)
```

## Modeling

### Unconditional means

```{r}
unconditional.means <- lmer(y ~ 1 + (1|participant) + (1|item),
                           data=long
                           )
summary(unconditional.means)
```

```{r}
performance::icc(unconditional.means, by_group=TRUE)
```

### Primary model

```{r}
m1 <- lmer(y ~ 1 + age + gender + education + ethnicity + hispanic + diagnosis_subtype + hospitalization + banked + savings + trust_clinician + trust_carepartner + trust_bank + cfpb_score + care_partner_help + bfi_agreeableness + (1|participant) + (1|item), data=long)
```

```{r}
anova(m1)
```

### Main effects

```{r}

# H1.1: Comfort ratings will be lower during stable periods vs. symptomatic periods

avg_predictions(m1, hypothesis= ~ sequential, by='moodstate', re.form=NULL)
```

```{r}

# H2.1: Among intervention levels, comfort ratings will be lowest for spending restrictions

avg_predictions(m1, by=c('moodstate', 'context'), re.form=NULL)
```

```{r}

# H3.1: Comfort will be highest for care partners

avg_predictions(m1, by='actors', re.form=NULL)
```

### Interaction effects

### Interaction effects with respondent characteristics

## Additional analysis

```{r}
m2 <- lm(cfpb_score ~ diagnosis_subtype, data=long)
```

```{r}
long$trust_bank <- ordered(long$trust_bank, levels=c('Extremely difficult', 'Somewhat difficult', 'Neither easy nor difficult', 'Somewhat easy', 'Extremely easy'))
long$trust_carepartner <- ordered(long$trust_carepartner, levels=c('Extremely difficult', 'Somewhat difficult', 'Neither easy nor difficult', 'Somewhat easy', 'Extremely easy'))
long$trust_clinician <- ordered(long$trust_clinician, levels=c('Extremely difficult', 'Somewhat difficult', 'Neither easy nor difficult', 'Somewhat easy', 'Extremely easy'))
```
