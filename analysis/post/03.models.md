NIH BD/Finhealth Survey - Models
================

``` r
install.packages('pacman', repos = "https://cloud.r-project.org")
pacman::p_load(
  "modelsummary",
  "tidyverse",
  "lme4", 
  "ordinal", 
  "multcomp", 
  "mclogit", 
  "nnet", 
  "psych", 
  "car", 
  "ggstats", 
  "ggthemes", 
  "performance", 
  "marginaleffects",
  "effects",
  "broom.mixed",
  "broom.helpers",
  "gtsummary",
  "dplyr",
  "kableExtra", 
  "flextable", 
  "xtable", 
  "scales", 
  "pander",
  "patchwork",
  "Cairo",
  "gt"
)
```

## Load data

``` r
load('data/NIH_survey.Rdata')
```

## Descriptive statistics

### Means of outcome for all vignettes

``` r
tab <- long %>% 
summarize(
          Mean = mean(y, na.rm = TRUE),
          Median = median(y, na.rm = TRUE),
          SD = sd(y, na.rm = TRUE),
          ci = list(mean_cl_normal(y, conf.int = .95)),
          obs = n_distinct(participant)
) %>% unnest(c(ci))

save_as_image(theme_vanilla(autofit(theme_vanilla(flextable(tab)) %>% colformat_double(digits = 2))), 'tables/tbl-all-descriptives.png', res=600)
```

### Means of outcome for each vignette

``` r
tab_vig <- long %>% group_by(actors, context, moodstate) %>% rename(Actors=actors, 'Intervention Context'=context, 'Mood State'=moodstate) %>%
summarize(
          Mean = mean(y, na.rm = TRUE),
          Median = median(y, na.rm = TRUE),
          SD = sd(y, na.rm = TRUE),
          ci = list(mean_cl_normal(y, conf.int = .95) %>%
                      rename(Mean2 = y, Lower = ymin, Upper = ymax)),
          Obs = n_distinct(participant)
) %>% unnest %>% 
  dplyr::select(-Mean2)
print(xtable(tab_vig, type='latex', tabular.environment='longtable'), file='tables/tbl-vignette-descriptives.tex')
save_as_image(theme_vanilla(autofit(flextable(tab_vig)) %>% colformat_double(digits = 2)), 'tables/tbl-vignette-descriptives.png', res=600)
```

## Modeling

### Unconditional means

``` r
unconditional.means <- lmer(y ~ 1 + (1|participant) + (1|item), data=long)
summary(unconditional.means)
```

``` r
performance::icc(unconditional.means, by_group=TRUE)
```

### Primary model

``` r
m1 <- lmer(y ~ 1 + actors + context + moodstate + age + gender + education + income + ethnicity + hispanic + diagnosis_subtype + hospitalization + banked + savings + trust_clinician + trust_carepartner + trust_bank + cfpb_score + care_partner_help + bfi_agreeableness + (1|participant) + (1|item), data=long)

modelsummary(m1)
```

``` r
car::Anova(m1, type=3)
```

``` r
m1 |>
  tbl_regression(
    tidy_fun = tidy_marginal_predictions,
    label = list(
      actors = "Actors",
      context = "Intervention Context",
      moodstate = "Mood State",
      age = "Age Range",
      gender = "Gender",
      education = "Education",
      income = "Income",
      ethnicity = "Ethnicity",
      hispanic = "Hispanic",
      diagnosis_subtype = "Diagnosis Subtype",
      hospitalization = "Prior Hospitalzation",
      banked = "Banked",
      savings = "Savings",
      trust_clinician = "Ease in Trusting Clinician",
      trust_carepartner = "Ease in Trusting Care Partner",
      trust_bank = "Ease in Trusting Banks",
      cfpb_score = "CFPB Financial Wellbeing Score",
      care_partner_help = "Asked for Help with Impulsive Spending",
      bfi_agreeableness = "Agreeableness (BFI10)"
    )
  ) |>
  bold_labels()
```

### Main effects

#### ❌ H1.1: Comfort ratings will be lower during stable periods vs. symptomatic periods

``` r
# pairwise test
# m2 is main effects model

m2 <- lmer(y ~ 1 + actors + context + moodstate + diagnosis_subtype + (1|participant) + (1|item), data=long)
saveRDS(m2, file='models/m2.rds')

car::Anova(m2, type=3)

hypotheses(avg_predictions(m2, by='moodstate', re.form=NULL))
hypotheses(avg_predictions(m2, by='moodstate', re.form=NULL), 'b2=b1')
avg_predictions(m2, by='diagnosis_subtype', re.form=NULL)
hypotheses(avg_predictions(m2, by='diagnosis_subtype', re.form=NULL), ~meandev)

# Figure caption: Overall comfort ratings were lower during euthymic periods when compared to symptomatic periods.
ggsave('plots/H1.1_main_moodstate.eps', width=9, height=7, units='in', device='eps', plot_predictions(m2, by=('moodstate')) +
  labs(x='Mood State', y='Rating') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H2.1: Among intervention levels, comfort ratings will be lowest for spending restrictions

``` r
# calculate as the difference between an estimate and the mean of all estimates

avg_predictions(m2, by='context', re.form=NULL, hypothesis = difference~meandev)

# Figure caption: Respondents were least comfortable overall with a hypothetical 48-hour spending restriction intervention.
ggsave('plots/H2.1_main_context.eps', width=8, height=6, units='in', device='eps', plot_predictions(m2, by=c('context')) +
  labs(x='Intervention Context', y='Rating') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H3.1: Comfort will be highest for care partners

``` r
# as meandev, like above

hypotheses(avg_predictions(m2, variables='actors', re.form=NULL), multcomp='holm')

# Figure caption Respondents were most comfortable sharing financial data with care partners.
ggsave('plots/H3.1_main_actors.eps', width=9, height=7, units='in', device='eps', plot_predictions(m2, by='actors') +
  labs(x='Actors', y='Rating') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato')
)
```

### Interaction effects

#### ❌ H1.2: Among intervention levels, comfort ratings will be highest for shared spending behaviors during mood episodes (H0: predicted estimate=mean estimate)

``` r
# m3 is interaction between intervention context and mood state

m3 <- lmer(y ~ actors + context * moodstate + diagnosis_subtype + (1|participant) + (1|item), data=long)
saveRDS(m3, file='models/m3.rds')
avg_predictions(m3, by=c('moodstate', 'context'), hypothesis=difference~meandev, re.form=NULL)
```

#### ✅ H1.3: Among intervention levels, comfort ratings for spending restrictions will be higher during mood episodes vs. during stable periods (H0: ‘b1=b4’)

``` r
avg_predictions(m3, by=c('moodstate', 'context'))
avg_predictions(m3, by=c('moodstate', 'context'), hypothesis='b1=b4', re.form=NULL)

# Figure caption: Respondents were significantly more comfortable with spending restrictions during symptomatic periods. 

ggsave('plots/H1.3_interaction_context_moodstate.eps', width=8, height=6, units='in', device='eps', plot_predictions(m3, by=c('context', 'moodstate')) +
  labs(x='Intervention Context', y='Rating', color='Mood State') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato')
)
```

### Interaction effects with respondent characteristics

#### ✅ H2.2: Evidence of advanced planning behaviors (e.g., psych. advance directive) will lead to higher comfort ratings when sharing spending behaviors (H0: ‘b6=b3’)

``` r
m4 <- lmer(y ~ actors + context * PAD + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m4, by=c('PAD', 'context'))
avg_predictions(m4, newdata=datagrid(PAD=c('Yes', 'No'), context=c("48-hour Spending Restriction", "Help with Planning & Budgeting", "Share Spending Details")), by=c('PAD', 'context'), hypothesis='b6=b3')

# Figure caption: Respondents with psychiatric advance directives were more comfortable with all hypothetical interventions.
ggsave('plots/H2.2_interaction_context_PAD.eps', width=9, height=7, units='in', device='eps', plot_predictions(m4, newdata=datagrid(PAD=c('Yes', 'No'), context=c("48-hour Spending Restriction", "Help with Planning & Budgeting", "Share Spending Details")), by=c('context', 'PAD')) +
  labs(x='Intervention Context', y='Rating', color='Psychiatric Advance\nDirective?') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H2.3: Evidence of adverse financial events (e.g., prior bankruptcy) will lead to higher comfort ratings of spending restrictions (H0: ‘b7=b1’)

``` r
m5 <- lmer(y ~ actors + context * bankruptcy_declared + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m5, by=c('bankruptcy_declared', 'context'), hypothesis='b7=b1')
avg_predictions(m5, newdata=datagrid(bankruptcy_declared=c('Yes', 'No')), by=c('bankruptcy_declared', 'context')) 

# Figure caption: Respondents who had declared bankruptcy were significantly more comfortable with 48-hour spending restrictions.
ggsave('plots/H2.3_interaction_context_bankruptcydeclared.eps', width=9, height=6, units='in', device='eps', plot_predictions(m5, newdata=datagrid(bankruptcy_declared=c('Yes', 'No'), context=c("48-hour Spending Restriction", "Help with Planning & Budgeting", "Share Spending Details")), by=c('context', 'bankruptcy_declared')) +
  labs(x='Intervention Context', y='Rating', color='Bankruptcy Declared?') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato')
)

# Exploratory Considering bankruptcy will lead to higher comfort ratings of spending restrictions

m5.1 <- lmer(y ~ actors + context * bankruptcy_considered + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m5.1, by=c('bankruptcy_considered', 'context', 'moodstate'))

# Figure caption:
ggsave('plots/expl_interaction_context_bankruptcyconsidered.eps', width=9, height=6, units='in', device='eps', plot_predictions(m5.1, by=c('context', 'bankruptcy_considered', 'moodstate')) +
  labs(x='Intervention Context', y='Rating', color='Bankruptcy Considered?') +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_y_continuous(limits=c(1,7)) +
  theme_light(base_family='Lato') +
  facet_wrap(~moodstate, scales='free_x')
)
```

#### ✅ H3.2: Higher levels of trust in third parties will be associated with higher comfort ratings for those respective third parties

``` r
# ✅ H3.2.1 High trust in clinicians predicts higher comfort ratings for Actor=Clinician
m6.1 <- lmer(y ~ actors * trust_clinician + context + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m6.1, by=c('trust_clinician', 'actors'))
avg_predictions(m6.1, by=c('trust_clinician', 'actors'), hypothesis='b6=b3')

# ✅ H3.2.2 Trust in care partners predicts higher comfort ratings for Actor=Care partner
m6.2 <- lmer(y ~ actors * trust_carepartner + context + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m6.2, by=c('trust_carepartner', 'actors'))
avg_predictions(m6.2, by=c('trust_carepartner', 'actors'), hypothesis='b5=b2')

# ✅ H3.2.3 Trust in banks predicts higher comfort ratings for actor=banks
m6.3 <- lmer(y ~ actors * trust_bank + context + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m6.3, by=c('trust_bank', 'actors'))
avg_predictions(m6.3, by=c('trust_bank', 'actors'), hypothesis='b4=b1')
```

#### ✅ H3.3 Prior requests for third-party aid in managing impulsive spending behaviors will be associated with higher comfort ratings across all third-party actors (versus those who have not requested help) (H0: ‘b2=b1’)

``` r
m7 <- lmer(y ~ actors * care_partner_help + context + moodstate + (1|participant) + (1|item), data=long)
hypotheses(avg_predictions(m7, newdata=datagrid(actors=c("Banks", "Care Partner", "Clinicians"), care_partner_help=c("Yes", "No")), by=c('care_partner_help')), "b2=b1")
```

#### ✅ H4.1: Agreeableness will have a significant (non-directional) effect on level of comfort

``` r
m8 <- lmer(y ~ actors + context + moodstate + diagnosis_subtype + bfi_agreeableness + (1|participant) + (1|item), data=long)
car::Anova(m8, type=3)
```

## Model Comparisons

``` r
models <- list(
  "Primary" = m1,
  "Main Effects" = m2,
  "Context * Mood" = m3,
  "Context * PAD" = m4,
  "Context * Bankruptcy" = m5,
  "Actors * Help-seeking" = m7,
  "Agreeableness" = m8
  )

# Extract and format formulas for each model
# The `map_chr()` function from `purrr` is used to iterate over the list.
formulas <- map_chr(models, ~as.character(formula(.x)) %>%
  str_c(collapse = " "))

# Create a data frame for the custom row
formula_row <- data.frame(
  term = "Formula",
  "Primary" = formulas[[1]],
  "Main Effects" = formulas[[2]],
  "Context * Mood" = formulas[[3]],
  "Context * PAD" = formulas[[4]],
  "Context * Bankruptcy" = formulas[[5]],
  "Actors * Help-seeking" = formulas[[6]],
  "Agreeableness" = formulas[[7]],
  stringsAsFactors = FALSE
)

gt_modelsummary <- modelsummary(models, add_rows = formula_row, statistic = 'conf.int', output='gt') %>% tab_options(latex.use_longtable=TRUE)
as_latex(gt_modelsummary) %>% as.character() %>% cat()
```
