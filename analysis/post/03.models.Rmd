---
title: "NIH BD/Finhealth Survey - Models"
output:
  rmarkdown::github_document:
    html_preview: false
---

```{r class.source = 'fold-hide', warning=FALSE, message=FALSE}
install.packages('pacman')
pacman::p_load("tidyverse", "lme4", "ordinal", "mclogit", "nnet", "psych", "ggstats", "ggthemes", "performance", "marginaleffects", "kableExtra", "flextable", "xtable", "scales")

```

## Load data

```{r}
load('data/NIH_survey.Rdata')
```

## Descriptive statistics

### Means of outcome for all vignettes

```{r}
tab <- long %>% 
summarize(
          Mean = mean(y, na.rm = TRUE),
          Median = median(y, na.rm = TRUE),
          SD = sd(y, na.rm = TRUE),
          ci = list(mean_cl_normal(y, conf.int = .95)),
          obs = n_distinct(participant)
) %>% unnest(c(ci))
theme_vanilla(flextable(tab)) %>% colformat_double(digits = 2)
```

### Means of outcome for each vignette

```{r, warning=FALSE, message=FALSE}
tab_vig <- long %>% group_by(actors, context, moodstate) %>%
summarize(
          Mean = mean(y, na.rm = TRUE),
          Median = median(y, na.rm = TRUE),
          SD = sd(y, na.rm = TRUE),
          ci = list(mean_cl_normal(y, conf.int = .95)),
          obs = n_distinct(participant)
) %>% unnest(c(ci))
print(xtable(tab_vig, type='latex', tabular.environment='longtable'), file='tables/tbl-vignette-descriptives.tex')
theme_vanilla(flextable(tab_vig)) %>% colformat_double(digits = 2)
```

## Modeling

### Unconditional means

```{r}
unconditional.means <- lmer(y ~ 1 + (1|participant) + (1|item), data=long)
summary(unconditional.means)
```

```{r}
performance::icc(unconditional.means, by_group=TRUE)
```

### Primary model

```{r}
m1 <- lmer(y ~ 1 + actors + context + moodstate + age + gender + education + ethnicity + hispanic + diagnosis_subtype + hospitalization + banked + savings + trust_clinician + trust_carepartner + trust_bank + cfpb_score + care_partner_help + bfi_agreeableness + (1|participant) + (1|item), data=long)
```

```{r}
car::Anova(m1, type=3)
```

### Main effects

#### ❌ H1.1: Comfort ratings will be lower during stable periods vs. symptomatic periods

```{r}

# pairwise test
# m2 is main effects model

m2 <- lmer(y ~ 1 + actors + context + moodstate + diagnosis_subtype + (1|participant) + (1|item), data=long)
saveRDS(m2, file='models/m2.rds')

car::Anova(m2, type=3)

hypotheses(avg_predictions(m2, by='moodstate', re.form=NULL))
hypotheses(avg_predictions(m2, by='moodstate', re.form=NULL), 'b2=b1')
avg_predictions(m2, by='diagnosis_subtype', re.form=NULL)

# Figure caption: Overall comfort ratings were lower during euthymic periods when compared to symptomatic periods.
ggsave('plots/H1.1_main_moodstate.png', width=9, height=7, units='in', dpi=600, plot_predictions(m2, by=c('diagnosis_subtype', 'moodstate')) +
  labs(x='Diagnosis Subtype', y='Rating', color='Mood State') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H2.1: Among intervention levels, comfort ratings will be lowest for spending restrictions

```{r}

# calculate as the difference between an estimate and the mean of all estimates

avg_predictions(m2, by='context', re.form=NULL, hypothesis = difference~meandev)

# Figure caption: Respondents were least comfortable overall with a hypothetical 48-hour spending restriction intervention.
ggsave('plots/H2.1_main_context.png', width=9, height=7, units='in', dpi=600, plot_predictions(m2, by=c('context')) +
    labs(x='Intervention Context', y='Rating') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H3.1: Comfort will be highest for care partners

```{r}

# as meandev, like above

hypotheses(avg_predictions(m2, variables='actors', re.form=NULL), multcomp='holm')

# Figure caption Respondents were most comfortable sharing financial data with care partners.
ggsave('plots/H3.1_main_actors.png', width=9, height=7, units='in', dpi=600, plot_predictions(m2, by='actors') +
  labs(x='Actors', y='Rating') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)
```

### Interaction effects

#### ❌ H1.2: Among intervention levels, comfort ratings will be highest for shared spending behaviors during mood episodes

```{r}

# m3 is interaction between intervention context and mood state

m3 <- lmer(y ~ actors + context * moodstate + diagnosis_subtype + (1|participant) + (1|item), data=long)
saveRDS(m3, file='models/m3.rds')
avg_predictions(m3, by=c('moodstate', 'context'), hypothesis=difference~meandev, re.form=NULL)

# Figure caption: Respondents were most comfortable seeking help with planning and budgeting, regardless of the presence of a mood episode.
ggsave('plots/H1.2_interaction_context_moodstate.png', width=9, height=7, units='in', dpi=600, plot_predictions(m3, by=c('context', 'moodstate')) +
  labs(x='Intervention Context', y='Rating', color='Mood State') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H1.3: Among intervention levels, comfort ratings for spending restrictions will be higher during mood episodes vs. during stable periods (H0: 'b1=b4')

```{r}

avg_predictions(m3, by=c('moodstate', 'context'))
avg_predictions(m3, by=c('moodstate', 'context'), hypothesis='b1=b4', re.form=NULL)

```

###  Interaction effects with respondent characteristics

#### ✅ H2.2: Evidence of advanced planning behaviors (e.g., psych. advance directive) will lead to higher comfort ratings when sharing spending behaviors (H0: 'b3=b9')

```{r}

m4 <- lmer(y ~ actors + context * PAD + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m4, by=c('PAD', 'context'))
avg_predictions(m4, by=c('PAD', 'context'), hypothesis='b9=b3')

# Figure caption: Respondents with psychiatric advance directives were more comfortable with all hypothetical interventions.
ggsave('plots/H2.2_interaction_context_PAD.png', width=9, height=7, units='in', dpi=600, plot_predictions(m4, by=c('context', 'PAD')) +
  labs(x='Intervention Context', y='Rating', color='Psychiatric Advance\nDirective?') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H2.3: Evidence of adverse financial events (e.g., prior bankruptcy) will lead to higher comfort ratings of spending restrictions

```{r}

m5 <- lmer(y ~ actors + context * bankruptcy_declared + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m5, by=c('bankruptcy_declared', 'context'))
avg_predictions(m5, by=c('bankruptcy_declared', 'context'), hypothesis='b7=b1') 

# Figure caption: Respondents who had declared bankruptcy were significantly more comfortable with 48-hour spending restrictions.
ggsave('plots/H2.3_interaction_context_bankruptcydeclared.png', width=9, height=7, units='in', dpi=600, plot_predictions(m5, by=c('context', 'bankruptcy_declared')) +
  labs(x='Intervention Context', y='Rating', color='Bankruptcy Declared?') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)

# Exploratory Considering bankruptcy will lead to higher comfort ratings of spending restrictions

m5.1 <- lmer(y ~ actors + context * bankruptcy_considered + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m5.1, by=c('bankruptcy_considered', 'context'))

# Figure caption:
ggsave('plots/exp_interaction_context_bankruptcyconsidered.png', width=9, height=7, units='in', dpi=600, plot_predictions(m5.1, by=c('context', 'bankruptcy_considered')) +
  labs(x='Intervention Context', y='Rating', color='Bankruptcy Considered?') +
  scale_x_discrete(labels = label_wrap(10)) +
  theme_light(base_family='Lato')
)
```

#### ✅ H3.2: Higher levels of trust in third parties will be associated with higher comfort ratings for those respective third parties

```{r}

# ✅ H3.2.1 High trust in clinicians predicts higher comfort ratings for Actor=Clinician
m6.1 <- lmer(y ~ actors * trust_clinician + context + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m6.1, by=c('trust_clinician', 'actors'))
avg_predictions(m6.1, by=c('trust_clinician', 'actors'), hypothesis='b6=b3')

# ✅ H3.2.2 Trust in care partners predicts higher comfort ratings for Actor=Care partner
m6.2 <- lmer(y ~ actors * trust_carepartner + context + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m6.2, by=c('trust_carepartner', 'actors'))
avg_predictions(m6.2, by=c('trust_carepartner', 'actors'), hypothesis='b5=b2')

# ✅ H3.2.3 Trust in banks predicts higher comfort ratings for actor=banks
m6.3 <- lmer(y ~ actors * trust_bank + context + moodstate + (1|participant) + (1|item), data=long)
avg_predictions(m6.3, by=c('trust_bank', 'actors'))
avg_predictions(m6.3, by=c('trust_bank', 'actors'), hypothesis='b4=b1')

```

#### ❌ H3.3 Prior requests for third-party aid in managing impulsive spending behaviors will be associated with higher comfort ratings across all third-party actors (versus those who have not requested help)

```{r}

m7 <- lmer(y ~ actors * care_partner_help + context + moodstate + (1|participant) + (1|item), data=long)
hypotheses(avg_predictions(m7, by=c('actors', 'care_partner_help')), ~meandev, multcomp='holm')
```

#### ✅ H4.1: Agreeableness will have a significant (non-directional) effect on level of comfort

```{r}

m8 <- lmer(y ~ actors + context + moodstate + diagnosis_subtype + bfi_agreeableness + (1|participant) + (1|item), data=long)
car::Anova(m8, type=3)
```

## Additional analysis

### Requests for care partner help

```{r}
m9 <- lmer(y ~ actors + context + moodstate + diagnosis_subtype + care_partner_help + (1|participant) + (1|item), data=long)
car::Anova(m9, type=3)≥≥
ggsave('plots/expl_main_carepartnerhelp_actors.png', width=8, height=6, dpi=600, plot_predictions(m9, by=c('actors', 'care_partner_help')) + 
  labs(x='Actor', y='Rating', color='Asked for Help with\nImpulsive Spending') +
  theme_light(base_family='Lato') +
  scale_x_discrete(labels = label_wrap(30))
)
```

```{r}
m9.1 <- lmer(y ~ actors * care_partner_help + context + moodstate + diagnosis_subtype + (1|participant) + (1|item), data=long)
ggsave('plots/expl_interaction_carepartnerhelp_actors_moodstate.png', width=12, height=6, dpi=600, plot_predictions(m9.1, by=c('actors', 'care_partner_help', 'moodstate')) + 
  labs(x='Actor', y='Rating', color='Asked for Help with\nImpulsive Spending') +
  theme_light(base_family='Lato') +
  scale_x_discrete(labels = label_wrap(30)) +
  facet_wrap(~moodstate, scales='free_x')
)
```

```{r}
m9.2 <- lmer(y ~ actors + context * care_partner_help + moodstate + diagnosis_subtype + (1|participant) + (1|item), data=long)
ggsave('plots/expl_interaction_carepartnerhelp_context.png', width=10, height=6, dpi=600, plot_predictions(m9.2, by=c('context',  'care_partner_help', 'moodstate')) + 
  labs(x='Intervention Context', y='Rating', color='Asked for Help with\nImpulsive Spending') +
  theme_light(base_family='Lato') +
  scale_x_discrete(labels = label_wrap(20)) +
  facet_wrap(~moodstate, scales='free_x')
)
```

```{r}
m9.3 <- lmer(y ~ actors + context + moodstate + diagnosis_subtype + diagnosis_age * care_partner_help + (1|participant) + (1|item), data=long)
ggsave('plots/expl_interaction_carepartnerhelp_diagnosisage.png', width=12, height=6, dpi=600, plot_predictions(m9.3, by=c('context',  'care_partner_help', 'diagnosis_age')) + 
  labs(x='Intervention Context', y='Rating', color='Asked for Help with\nImpulsive Spending') +
  theme_light(base_family='Lato') +
  scale_x_discrete(labels = label_wrap(20)) +
  facet_wrap(~diagnosis_age, scales='free_x')
)
```
m9 <- lmer(y ~ actors + context + moodstate + diagnosis_subtype + care_partner_help + (1|participant) + (1|item), data=long)

### Financial goals

```{r}

# Main financial goal and vignettes

m10 <- lmer(y ~ actors + context  + moodstate + main_financial_goal + diagnosis_subtype + (1|participant) + (1|item), data=long)
car::Anova(m10, type=3)

ggsave('plots/expl_main_financialgoal_context.png', width=8, height=6, dpi=600, plot_predictions(m10, by=c('main_financial_goal', 'context')) + 
  labs(x='Main Financial Goal', y='Rating', color='Intervention Context') +
  theme_light(base_family='Lato') + 
  theme(axis.text.x = element_text(size=8, angle = 45, hjust = 1)) + 
  scale_x_discrete(labels = label_wrap(30))
)

# Main financial goals with interactions

m10.1 <- lmer(y ~ actors + context + moodstate + main_financial_goal * diagnosis_subtype + (1|participant) +(1|item), data=long)
ggsave('plots/expl_interaction_financialgoal_context_diagnosis.png', width=14, height=8, dpi=600, plot_predictions(m10.1, by=c('main_financial_goal', 'diagnosis_subtype', 'context')) + 
  labs(x='Main Financial Goal', y='Rating', color='Diagnosis Subtype') +
  theme_light(base_family='Lato') + 
  theme(axis.text.x = element_text(size=8, angle = 45, hjust = 1)) + 
  scale_x_discrete(labels = label_wrap(30)) +
  facet_wrap(~ context, scales='free_x')
)

m10.2 <- lmer(y ~ actors + context + moodstate + main_financial_goal * bankruptcy_declared + diagnosis_subtype + (1|participant) +(1|item), data=long)
ggsave('plots/expl_interaction_financialgoal_actors_bankruptcydeclared.png', width=14, height=8, dpi=600, plot_predictions(m10.2, by=c('main_financial_goal', 'actors', 'bankruptcy_declared')) + 
  labs(x='Main Financial Goal', y='Rating', color='Actors') +
  theme_light(base_family='Lato') + 
  theme(axis.text.x = element_text(size=8, angle = 45, hjust = 1)) + 
  scale_x_discrete(labels = label_wrap(30)) +
  facet_wrap(~bankruptcy_declared, scales='free_x')
)

m10.3 <- lmer(y ~ actors + context * main_financial_goal + moodstate + bankruptcy_declared + diagnosis_subtype + (1|participant) +(1|item), data=long)
ggsave('plots/expl_interaction_financialgoal_context_moodstate.png', width=14, height=8, dpi=600, plot_predictions(m10.3, by=c('main_financial_goal', 'context', 'moodstate')) + 
  labs(x='Main Financial Goal', y='Rating', color='Context') +
  theme_light(base_family='Lato') + 
  theme(axis.text.x = element_text(size=8, angle = 45, hjust = 1)) + 
  scale_x_discrete(labels = label_wrap(30)) +
  facet_wrap(~moodstate, scales='free_x')
)
```

```{r}

# Main financial goal * bankruptcy declared and vignettes
m11 <- lmer(y ~ actors + context  + moodstate + main_financial_goal * bankruptcy_declared + diagnosis_subtype + (1|participant) + (1|item), data=long)
car::Anova(m11, type=3)

avg_predictions(m11, by=c('main_financial_goal', 'bankruptcy_declared'))

ggsave('plots/expl_interaction_financialgoal_context_bankruptcy.png', width=12, height=6 , dpi=600, plot_predictions(m11, by=c('main_financial_goal', 'context', 'bankruptcy_declared')) + 
  labs(title='Bankruptcy Declared?', x='Main Financial Goal', y='Rating', color='Intervention Context') +
  theme_light(base_family='Lato') + 
  theme(axis.text.x = element_text(size=7, angle = 45, hjust = 1)) + 
  scale_x_discrete(labels = label_wrap(35)) +
  facet_wrap(~bankruptcy_declared, scales='free_x')
)
```

### BFI10 and vignettes

```{r}

# Model BFI10 with main effects

m12bfi <- lmer(y ~ actors + context + moodstate + diagnosis_subtype + bfi_extraversion + bfi_agreeableness + bfi_conscientiousness + bfi_neuroticism + bfi_openness + (1|participant) + (1|item), data=long)

car::Anova(m12bfi, type=3)
plot_predictions(m12bfi, condition=c('bfi_extraversion', 'diagnosis_subtype'))
plot_predictions(m12bfi, condition=c('bfi_agreeableness', 'diagnosis_subtype'))
plot_predictions(m12bfi, condition=c('bfi_conscientiousness', 'diagnosis_subtype'))
plot_predictions(m12bfi, condition=c('bfi_neuroticism', 'diagnosis_subtype'))
plot_predictions(m12bfi, condition=c('bfi_openness', 'diagnosis_subtype'))
```

### Actors (SSRI and NIH survey)

```{r}

# Create combined frame
env.2 <- loadEnvironment('../../../SSRI/data/finhealth_data.Rdata')
long.sample1 <- env.2$long
long.sample1$sample <- 1
long.sample1$participant <- as.numeric(paste0("1", long.sample$participant))
long.sample1 <- long.sample1 %>% mutate(actors = recode(actors, "clinician" = "Clinicians", "family" = "Family", "you" = "Self"))
long.sample2 <- long
long.sample2$sample <- 2
long.sample2$duration <- as.numeric(long.sample2$duration)
combined.samples <- bind_rows(long.sample1, long.sample2)

# Create combined model
combined.model <- lmer(y ~ actors + (1|participant) + (1|item) + (1|sample), data=combined.samples)

# Marginal predictions
avg_predictions(combined.model, by="actors")
```

```{r}

# Are people okay sharing things between stability vs illness?
m13 <- lmer(y ~ actors + (1|participant) + (1|item), data=env.2$long)
avg_predictions(m13, by='actors')
```

```{r}

# Model neuroticism between moodstate (as neuroticism has stepwise effect in prior work)

avg_predictions(m12bfi, variables='bfi_neuroticism', by='moodstate', hypothesis=difference~reference)
plot_predictions(m12bfi, condition=c('bfi_neuroticism', 'diagnosis_subtype'))
```

### Diagnosis and bankruptcy rates

```{r}
chisq.test(x = wide$diagnosis_subtype, y = wide$bankruptcy_declared, simulate.p.value=TRUE)
fisher.test(table(wide$diagnosis_subtype, wide$bankruptcy_declared))
```

```{r}
long$trust_bank <- ordered(long$trust_bank, levels=c('Extremely difficult', 'Somewhat difficult', 'Neither easy nor difficult', 'Somewhat easy', 'Extremely easy'))
long$trust_carepartner <- ordered(long$trust_carepartner, levels=c('Extremely difficult', 'Somewhat difficult', 'Neither easy nor difficult', 'Somewhat easy', 'Extremely easy'))
long$trust_clinician <- ordered(long$trust_clinician, levels=c('Extremely difficult', 'Somewhat difficult', 'Neither easy nor difficult', 'Somewhat easy', 'Extremely easy'))
```